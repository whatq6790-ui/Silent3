<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Camera Pro</title>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-bg: #000000;
            --ios-card: #1C1C1E;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

```
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--ios-bg);
        color: white;
        overflow: hidden;
        width: 100%; height: 100%;
        user-select: none;
    }

    /* --- Camera View --- */
    #camera-view {
        position: relative; width: 100%; height: 100%;
        display: flex; flex-direction: column;
    }
    #video { width: 100%; height: 100%; object-fit: cover; }
    
    .camera-controls {
        position: absolute; bottom: 0; width: 100%;
        padding: 20px 30px calc(40px + var(--safe-bottom));
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        display: flex; justify-content: space-between; align-items: center;
    }
    .shutter-outer {
        width: 72px; height: 72px; border-radius: 50%;
        border: 4px solid white; display: flex; justify-content: center; align-items: center;
        cursor: pointer;
    }
    .shutter-inner {
        width: 60px; height: 60px; background: white; border-radius: 50%;
        transition: transform 0.1s;
    }
    .shutter-outer:active .shutter-inner { transform: scale(0.9); }
    .control-icon {
        width: 44px; height: 44px; background: rgba(255,255,255,0.2);
        border-radius: 50%; display: flex; justify-content: center; align-items: center;
        backdrop-filter: blur(10px); cursor: pointer; font-size: 20px;
    }
    .preview-thumb {
        width: 44px; height: 44px; border-radius: 6px; overflow: hidden;
        background: #333; border: 1px solid rgba(255,255,255,0.5);
        cursor: pointer;
    }
    .preview-thumb img { width: 100%; height: 100%; object-fit: cover; }

    /* --- Gallery View --- */
    #gallery-view {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: var(--ios-bg); z-index: 100;
        display: none; flex-direction: column;
        transform: translateY(100%); transition: transform 0.3s ease-out;
    }
    #gallery-view.active { display: flex; transform: translateY(0); }

    /* Header */
    .gallery-header {
        padding: calc(10px + var(--safe-top)) 16px 10px;
        background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
        display: flex; justify-content: space-between; align-items: flex-end;
        border-bottom: 0.5px solid #333;
    }
    .header-title { font-size: 20px; font-weight: 600; }
    .header-btn {
        font-size: 17px; color: var(--ios-blue);
        background: none; border: none; cursor: pointer; padding: 5px;
    }
    .header-btn.cancel { font-weight: 600; }

    /* Grid */
    .gallery-content { flex: 1; overflow-y: auto; padding: 2px; }
    .photo-grid {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px;
    }
    .grid-item {
        aspect-ratio: 1/1; position: relative; cursor: pointer;
    }
    .grid-item img {
        width: 100%; height: 100%; object-fit: cover; display: block;
    }
    /* Selection Circle */
    .check-circle {
        position: absolute; bottom: 6px; right: 6px;
        width: 22px; height: 22px; border-radius: 50%;
        border: 1px solid rgba(255,255,255,0.8);
        background: rgba(0,0,0,0.3);
        display: none; /* Hidden by default */
        align-items: center; justify-content: center;
    }
    .selection-mode .check-circle { display: flex; }
    .grid-item.selected .check-circle {
        background: var(--ios-blue); border-color: var(--ios-blue);
    }
    .grid-item.selected .check-circle::after {
        content: '‚úì'; font-size: 14px; font-weight: bold; color: white;
    }
    .grid-item.selected img { opacity: 0.7; }

    /* Bottom Bars */
    .bottom-bar-container {
        height: calc(50px + var(--safe-bottom));
        background: rgba(20,20,20,0.95); backdrop-filter: blur(20px);
        border-top: 0.5px solid #333;
    }
    /* Tab Bar (Default) */
    .tab-bar {
        display: flex; justify-content: space-around; align-items: center;
        height: 100%; padding-bottom: var(--safe-bottom);
    }
    .tab-item {
        display: flex; flex-direction: column; align-items: center;
        color: #888; font-size: 10px; cursor: pointer; width: 60px;
    }
    .tab-item.active { color: var(--ios-blue); }
    .tab-icon { font-size: 24px; margin-bottom: 2px; }

    /* Action Bar (Selection Mode) */
    .action-bar {
        display: none; justify-content: space-between; align-items: center;
        height: 100%; padding: 0 30px calc(var(--safe-bottom));
    }
    .action-btn {
        background: none; border: none; cursor: pointer;
        color: var(--ios-blue); font-size: 26px;
    }
    .action-btn.delete { color: #888; } /* Disabled state style initially */
    .action-btn.active-delete { color: #ff3b30; }

    /* --- Full Preview --- */
    #preview-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 200; display: none; flex-direction: column;
    }
    .preview-nav {
        padding: calc(10px + var(--safe-top)) 16px 10px;
        display: flex; justify-content: space-between; align-items: center;
    }
    .preview-img-container {
        flex: 1; display: flex; align-items: center; justify-content: center;
        touch-action: pan-y; /* Allow vertical scroll but prevent horizontal */
    }
    .preview-img-container img { 
        max-width: 100%; max-height: 100%; object-fit: contain;
        user-select: none;
        -webkit-user-drag: none;
    }
    .preview-tools {
        padding: 20px 40px calc(30px + var(--safe-bottom));
        display: flex; justify-content: space-between;
    }

    /* Flash */
    .flash {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: white; opacity: 0; pointer-events: none; z-index: 300;
    }
    .flash.flash-anim { animation: flash 0.25s ease-out; }
    @keyframes flash { 0% {opacity: 1;} 100% {opacity: 0;} }

    /* Utility */
    .hidden { display: none !important; }
</style>
```

</head>
<body>

```
<!-- Camera -->
<div id="camera-view">
    <video id="video" autoplay playsinline muted></video>
    <div class="camera-controls">
        <div class="preview-thumb" id="cam-thumb-btn">
            <img id="cam-thumb-img" src="" style="display:none">
        </div>
        <div class="shutter-outer" id="shutter-btn"><div class="shutter-inner"></div></div>
        <div class="control-icon" id="flip-btn">üîÑ</div>
    </div>
</div>

<!-- Gallery -->
<div id="gallery-view">
    <div class="gallery-header">
        <button class="header-btn" id="gallery-back-btn">Ôºú „Ç´„É°„É©</button>
        <span class="header-title" id="header-title">ÊúÄËøë„ÅÆÈ†ÖÁõÆ</span>
        <button class="header-btn" id="select-mode-btn">ÈÅ∏Êäû</button>
    </div>

    <div class="gallery-content">
        <div class="photo-grid" id="photo-grid"></div>
    </div>

    <div class="bottom-bar-container">
        <!-- Normal Tab Bar -->
        <div class="tab-bar" id="tab-bar">
            <div class="tab-item active">
                <span class="tab-icon">üñºÔ∏è</span><span>„É©„Ç§„Éñ„É©„É™</span>
            </div>
            <div class="tab-item">
                <span class="tab-icon">‚ô•</span><span>„ÅäÊ∞ó„Å´ÂÖ•„Çä</span>
            </div>
        </div>
        <!-- Selection Action Bar -->
        <div class="action-bar" id="action-bar">
            <button class="action-btn" id="bulk-share-btn">üì§</button>
            <span style="font-size:14px; color:#888;" id="selected-count">0Êûö„ÇíÈÅ∏Êäû</span>
            <button class="action-btn delete" id="bulk-delete-btn">üóëÔ∏è</button>
        </div>
    </div>
</div>

<!-- Single Preview -->
<div id="preview-overlay">
    <div class="preview-nav">
        <button class="header-btn" id="preview-back-btn">Ôºú Êàª„Çã</button>
        <span style="font-size:14px; font-weight:600;">Ë©≥Á¥∞</span>
        <div style="width:40px"></div>
    </div>
    <div class="preview-img-container">
        <img id="preview-img" src="">
    </div>
    <div class="preview-tools">
        <button class="action-btn" id="single-share-btn">üì§</button>
        <button class="action-btn active-delete" id="single-delete-btn">üóëÔ∏è</button>
    </div>
</div>

<div class="flash" id="flash"></div>
<canvas id="canvas" style="display:none"></canvas>

<script>
    // DOM Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const flash = document.getElementById('flash');
    
    // Views
    const galleryView = document.getElementById('gallery-view');
    const previewOverlay = document.getElementById('preview-overlay');
    const photoGrid = document.getElementById('photo-grid');
    
    // Buttons
    const shutterBtn = document.getElementById('shutter-btn');
    const flipBtn = document.getElementById('flip-btn');
    const camThumbBtn = document.getElementById('cam-thumb-btn');
    const camThumbImg = document.getElementById('cam-thumb-img');
    const galleryBackBtn = document.getElementById('gallery-back-btn');
    const selectModeBtn = document.getElementById('select-mode-btn');
    const headerTitle = document.getElementById('header-title');
    
    // Bars
    const tabBar = document.getElementById('tab-bar');
    const actionBar = document.getElementById('action-bar');
    const selectedCountLabel = document.getElementById('selected-count');
    
    // Actions
    const bulkShareBtn = document.getElementById('bulk-share-btn');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    
    // State
    let stream = null;
    let facingMode = 'environment';
    let photos = []; // { id, url, blob }
    let isSelectionMode = false;
    let selectedIndices = new Set();
    let currentPreviewIndex = null;

    // --- Camera Functions with improved error handling ---
    async function initCamera() {
        if (stream) stream.getTracks().forEach(t => t.stop());
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode, width: { ideal: 4096 }, height: { ideal: 2160 } },
                audio: false
            });
            video.srcObject = stream;
        } catch (e) {
            console.error(e);
            alert('„Ç´„É°„É©„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇË®≠ÂÆö„Åã„ÇâË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        }
    }

    function takePhoto() {
        if (!video.videoWidth) return;
        
        // Flash
        flash.classList.remove('flash-anim');
        void flash.offsetWidth; // trigger reflow
        flash.classList.add('flash-anim');

        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            photos.unshift({ id: Date.now(), url, blob });
            updateCamThumb();
            renderGrid();
        }, 'image/jpeg', 0.9);
    }

    function updateCamThumb() {
        if (photos.length > 0) {
            camThumbImg.src = photos[0].url;
            camThumbImg.style.display = 'block';
        } else {
            camThumbImg.style.display = 'none';
        }
    }

    // --- Gallery Logic ---
    function renderGrid() {
        photoGrid.innerHTML = photos.map((p, i) => {
            const isSelected = selectedIndices.has(i);
            return `
            <div class="grid-item ${isSelected ? 'selected' : ''}" onclick="handleGridClick(${i})">
                <img src="${p.url}" loading="lazy">
                <div class="check-circle"></div>
            </div>
        `}).join('');
        
        // Update counts and button states
        selectedCountLabel.innerText = `${selectedIndices.size}Êûö„ÇíÈÅ∏Êäû`;
        if (selectedIndices.size > 0) {
            bulkDeleteBtn.classList.add('active-delete');
            bulkDeleteBtn.classList.remove('delete');
        } else {
            bulkDeleteBtn.classList.add('delete');
            bulkDeleteBtn.classList.remove('active-delete');
        }
    }

    function handleGridClick(index) {
        if (isSelectionMode) {
            // Toggle Selection
            if (selectedIndices.has(index)) {
                selectedIndices.delete(index);
            } else {
                selectedIndices.add(index);
            }
            renderGrid();
        } else {
            // Open Preview
            openPreview(index);
        }
    }

    function toggleSelectionMode() {
        isSelectionMode = !isSelectionMode;
        
        if (isSelectionMode) {
            selectModeBtn.innerText = '„Ç≠„É£„É≥„Çª„É´';
            selectModeBtn.classList.add('cancel');
            photoGrid.classList.add('selection-mode');
            headerTitle.innerText = 'È†ÖÁõÆ„ÇíÈÅ∏Êäû';
            galleryBackBtn.style.visibility = 'hidden'; // Hide back button
            
            tabBar.style.display = 'none';
            actionBar.style.display = 'flex';
            selectedIndices.clear();
        } else {
            selectModeBtn.innerText = 'ÈÅ∏Êäû';
            selectModeBtn.classList.remove('cancel');
            photoGrid.classList.remove('selection-mode');
            headerTitle.innerText = 'ÊúÄËøë„ÅÆÈ†ÖÁõÆ';
            galleryBackBtn.style.visibility = 'visible';

            tabBar.style.display = 'flex';
            actionBar.style.display = 'none';
            selectedIndices.clear();
        }
        renderGrid();
    }

    // --- Bulk Actions ---
    async function shareImages(indicesArray) {
        if (indicesArray.length === 0) return;

        const files = indicesArray.map(i => {
            const p = photos[i];
            return new File([p.blob], `photo_${p.id}.jpg`, { type: 'image/jpeg' });
        });

        try {
            if (navigator.canShare && navigator.canShare({ files })) {
                await navigator.share({
                    files: files,
                    title: 'ÂÜôÁúü„ÇíÂÖ±Êúâ'
                });
            } else {
                // Fallback: Download one by one (or just first one)
                alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰∏ÄÊã¨ÂÖ±Êúâ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ1Êûö„Åö„Å§‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                const link = document.createElement('a');
                link.href = photos[indicesArray[0]].url;
                link.download = `photo_${photos[indicesArray[0]].id}.jpg`;
                link.click();
            }
        } catch (err) {
            console.log('Share canceled or failed', err);
        }
    }

    function deleteImages(indicesArray) {
        if (indicesArray.length === 0) return;
        if (!confirm(`${indicesArray.length}Êûö„ÅÆÂÜôÁúü„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) return;

        // Remove from array (sort indices descending to avoid shift issues)
        indicesArray.sort((a, b) => b - a).forEach(idx => {
            photos.splice(idx, 1);
        });
        
        // Exit selection mode if empty or reset
        if (photos.length === 0) {
            if (isSelectionMode) toggleSelectionMode();
        } else {
            selectedIndices.clear();
            renderGrid();
        }
        updateCamThumb();
    }

    // --- Swipe Gesture for Preview ---
    let touchStartX = 0;
    const previewImg = document.getElementById('preview-img');

    previewImg.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
    });

    previewImg.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > 50) { // 50px‰ª•‰∏ä„ÅÆ„Çπ„ÉØ„Ç§„Éó
            if (diff > 0 && currentPreviewIndex < photos.length - 1) {
                // Â∑¶„Çπ„ÉØ„Ç§„ÉóÔºöÊ¨°„ÅÆÂÜôÁúü
                openPreview(currentPreviewIndex + 1);
            } else if (diff < 0 && currentPreviewIndex > 0) {
                // Âè≥„Çπ„ÉØ„Ç§„ÉóÔºöÂâç„ÅÆÂÜôÁúü
                openPreview(currentPreviewIndex - 1);
            }
        }
    });

    // --- Event Listeners ---
    shutterBtn.addEventListener('click', takePhoto);
    
    flipBtn.addEventListener('click', () => {
        facingMode = facingMode === 'environment' ? 'user' : 'environment';
        initCamera();
    });

    camThumbBtn.addEventListener('click', () => {
        if (photos.length === 0) return;
        galleryView.classList.add('active');
    });

    galleryBackBtn.addEventListener('click', () => {
        galleryView.classList.remove('active');
    });

    selectModeBtn.addEventListener('click', toggleSelectionMode);

    bulkShareBtn.addEventListener('click', () => {
        shareImages(Array.from(selectedIndices));
    });

    bulkDeleteBtn.addEventListener('click', () => {
        deleteImages(Array.from(selectedIndices));
    });

    // Preview Overlay Events
    function openPreview(index) {
        currentPreviewIndex = index;
        previewImg.src = photos[index].url;
        previewOverlay.style.display = 'flex';
    }

    document.getElementById('preview-back-btn').addEventListener('click', () => {
        previewOverlay.style.display = 'none';
    });

    document.getElementById('single-share-btn').addEventListener('click', () => {
        if (currentPreviewIndex !== null) shareImages([currentPreviewIndex]);
    });

    document.getElementById('single-delete-btn').addEventListener('click', () => {
        if (currentPreviewIndex !== null) {
            if(confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                photos.splice(currentPreviewIndex, 1);
                previewOverlay.style.display = 'none';
                renderGrid();
                updateCamThumb();
            }
        }
    });

    // Initialize
    initCamera();
</script>
```

</body>
</html>
